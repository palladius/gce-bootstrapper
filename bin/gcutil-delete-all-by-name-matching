#!/bin/bash

VER=1.0

# TODO: disable Region warning

DFLT_PROJ="google.com:biglamp"

# more a matching name than tag
TAG=${1:-test}
PROJ=${2:-$DFLT_PROJ}

echo "Usage: $0 <TAG> [<PROJECT_ID>]"
echo
echo "Deleting all entities from $PROJ with tag='$TAG': ANY/CTRL-C"
read ANY

GCUTIL="gcutil --project ${PROJ}"

rosso Deleting Instances:
$GCUTIL listinstances --format names | grep "$TAG" | sed -e 's:/: :g' | awk '{print $3}' | sort| xargs $GCUTIL deleteinstance -f

rosso Delete ForwardingRules:
$GCUTIL listforwardingrules --format csv | egrep -v "NO_RESULTS_ON_PAGE|code,message|name,description" | fgrep ',' | cut -f 1 -d, | grep "$TAG" | sort| uniq | xargs $GCUTIL deleteforwardingrule -f

rosso Deleting TargetPools:
$GCUTIL listtargetpools --format csv | fgrep ',' | cut -f 1 -d',' | grep "$TAG" | sort|uniq | xargs $GCUTIL deletetargetpool -f

#rosso Deleting Snaphosts: TODO # i have none to test :)
#$GCUTIL listsnapshots --format csv | fgrep ',' | cut -f 1 -d',' | grep "$TAG" 
